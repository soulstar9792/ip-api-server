<html>
  <head>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f9;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border: 1px solid #ddd;
      }

      th {
        background-color: #4caf50;
        color: white;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      tr:hover {
        background-color: #ddd;
      }

      h2 {
        text-align: center;
        color: #333;
      }

      .table-container {
        overflow-x: auto;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .btn {
        padding: 5px 10px;
        background-color: red;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }

      .btn:hover {
        background-color: darkred;
      }

      .checkbox {
        margin: 0;
      }

      .toggle-btn {
        padding: 5px 15px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }

      .toggle-btn.off {
        background-color: #f44336;
      }

      .toggle-btn:hover {
        background-color: #45a049;
      }

      .toggle-btn.off:hover {
        background-color: #e53935;
      }

      .hidden-row {
        display: none;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <div class="container">
      <div
        id="errorMessage"
        style="display: none; color: red; text-align: center; margin: 10px"
      ></div>
      <button class="toggle-btn off" id="toggleFilter" onclick="toggleFilter()">
        Show All
      </button>
      <form method="POST" action="/mine/delete">
        <div class="table-container">
          <table id="logsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Timestamp</th>
                <th>Country</th>
                <th>Region</th>
                <th>City</th>
                <th>Method</th>
                <th>Source</th>
                <th>IP</th>
                <th>Request URL</th>
              </tr>
            </thead>
            <tbody id="logsTableBody"></tbody>
          </table>
        </div>
      </form>
    </div>

    <script>
      // Initialize Firebase with error handling
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyAcVzAMWuYPOZ7CHIUXFnHMo34DKwFMe90",
          authDomain: "ip-api-check.firebaseapp.com",
          projectId: "ip-api-check",
          storageBucket: "ip-api-check.firebasestorage.app",
          messagingSenderId: "396717913614",
          appId: "1:396717913614:web:cce1489b2f1d232d666e5f",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log("Firebase initialized successfully");

        // Function to show error message
        function showError(message) {
          const errorDiv = document.getElementById("errorMessage");
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
        }

        // Function to create table row
        function createTableRow(doc, index) {
          try {
            const data = doc.data();
            const isFilteredOut = data.url === "/mine/list";
            const rowClass = isFilteredOut ? "hidden-row" : "";

            return `
                    <tr class="${rowClass} new-row" data-url="${
              data.url
            }" data-id="${doc.id}">
                      <td>${index}</td>
                      <td>${data.timestamp || "N/A"}</td>
                      <td>${data.country || "N/A"}</td>
                      <td>${data.regionName || "N/A"}</td>
                      <td>${data.city || "N/A"}</td>
                      <td>${data.method || "N/A"}</td>
                      <td>${data.source || "N/A"}</td>
                      <td>${data.ip || "N/A"}</td>
                      <td>${data.url || "N/A"}</td>
                    </tr>
                  `;
          } catch (err) {
            console.error("Error creating table row:", err);
            showError("Error creating table row");
            return "";
          }
        }

        // Real-time listener with error handling
        let rowCount = 0;
        const unsubscribe = db
          .collection("requests")
          .orderBy("timestamp", "asc")
          .onSnapshot(
            (snapshot) => {
              const tableBody = document.getElementById("logsTableBody");

              snapshot.docChanges().forEach((change) => {
                try {
                  if (change.type === "added") {
                    rowCount++;
                    const newRow = createTableRow(change.doc, rowCount);
                    tableBody.insertAdjacentHTML("afterbegin", newRow);

                    setTimeout(() => {
                      const row = document.querySelector(
                        `tr[data-id="${change.doc.id}"]`
                      );
                      if (row) row.classList.remove("new-row");
                    }, 2000);
                  } else if (change.type === "modified") {
                    const row = document.querySelector(
                      `tr[data-id="${change.doc.id}"]`
                    );
                    if (row) {
                      const index = row.querySelector("td").textContent;
                      const updatedRow = createTableRow(change.doc, index);
                      row.outerHTML = updatedRow;
                    }
                  } else if (change.type === "removed") {
                    const row = document.querySelector(
                      `tr[data-id="${change.doc.id}"]`
                    );
                    if (row) row.remove();
                  }
                } catch (err) {
                  console.error("Error handling document change:", err);
                  showError("Error updating table");
                }
              });
            },
            (error) => {
              console.error("Firestore listener error:", error);
              showError("Error connecting to database: " + error.message);
            }
          );

        // Clean up listener on page unload
        window.addEventListener("unload", () => {
          if (unsubscribe) unsubscribe();
        });
      } catch (err) {
        console.error("Firebase initialization error:", err);
        showError("Error initializing Firebase: " + err.message);
      }

      function toggleFilter() {
        const toggleBtn = document.getElementById("toggleFilter");
        const rows = document.querySelectorAll("tr[data-url='/mine/list']");

        if (toggleBtn.classList.contains("off")) {
          rows.forEach((row) => row.classList.remove("hidden-row"));
          toggleBtn.classList.remove("off");
          toggleBtn.textContent = "Hide '/mine/list' Entries";
        } else {
          rows.forEach((row) => row.classList.add("hidden-row"));
          toggleBtn.classList.add("off");
          toggleBtn.textContent = "Show All";
        }
      }
    </script>
  </body>
</html>
